Cmn.Version.CmnAjax="2.4.0","undefined"==typeof CmnMis&&(window.CmnMis={});var CmnAjax=Cmn.Ajax={Cfg:{ProxyUrl:"",ShowDefaultAjaxHint:1,ItfTokenKey:"ItfTokenKey",ItfVerifyCfgList:{},CookiePrefixParamName:"Cg_CookiePrefix",ParamForAllRequest:null},MethodNameToUrl:function(a){if(a.indexOf("/")>-1)return a;var b=window.location.href;return b.indexOf("?")>-1&&(b=b.substring(0,b.indexOf("?"))),b.indexOf("#")>-1&&(b=b.substring(0,b.indexOf("#"))),"/"==b[b.length-1]?b+a:b+"/"+a},FillDataByClass:function(a,b,c,d,e,f){return CmnAjax.FillData(a,b,c,d,e,f)},FillData:function(a,b,c,d,e,f,g){Cmn.FillData(a,[]),CmnAjax.ShowAjaxHandleHint(f,a),CmnAjax.PostData(b,c,function(b){return CmnAjax.HideAjaxHandleHint(f),g&&g(b.data),Cmn.FillData(a,b.data),d&&d(b),!0},function(){return CmnAjax.HideAjaxHandleHint(f),e&&e(),!1})},DataPaging:function(a,b,c,d,e,f,g,h,i,j){function l(d){null!=k.EventBeforePaging&&k.EventBeforePaging(),CmnAjax.ShowAjaxHandleHint(h,a),c||(c={}),c["CurPage"]=d,c["PageSize"]=e,CmnAjax.PostData(b,c,function(b){return CmnAjax.HideAjaxHandleHint(h),j&&j(b.data)===!1?!1:(Cmn.FillData(a,b.data),f&&f(b),!0)},function(d){return CmnAjax.HideAjaxHandleHint(h),g&&g(d),Cmn.Log("DataPaging填充数据时Ajax报错！dataContainerSelector:"+a+" methodName:"+b+" param:"+c+" 错误详细信息："+d.responseText),!1})}this.EventBeforePaging=null,Cmn.FillData(a,[]),i||(i=1),b=CmnAjax.MethodNameToUrl(b);var k=this;this.Paging=new Cmn.Paging(d,0,e,l),this.Refresh=function(){CmnAjax.ShowAjaxHandleHint(h,a),c||(c={}),c["CurPage"]=i,c["PageSize"]=e,CmnAjax.PostData(b,c,function(b){return CmnAjax.HideAjaxHandleHint(h),k.Paging.RecCount=b.RecCount?parseInt(b.RecCount):0,k.Paging.ToPage(i,!1),j&&j(b.data),Cmn.FillData(a,b.data),f&&f(b),!0},function(d){return CmnAjax.HideAjaxHandleHint(h),g&&g(d),Cmn.Log("DataPaging填充数据时Ajax报错！dataContainerSelector:"+a+" methodName:"+b+" param:"+c+"  错误详细信息："+d.responseText),!1})},this.Refresh(this.Paging)},DataStepLoad:function(a,b,c,d,e,f,g,h,i,j){var k,l,m;return this.CurrBlockNo=0,this.IsNewPage=!0,this.IsAddingBlock=!1,this.RecCount=100,this.Destroyed=!1,this.ScrollContainerSelector="",this.LoadingSensitivity=50,Cmn.FillData(a,[]),b=CmnAjax.MethodNameToUrl(b),k=this,l=a,Cmn.Func.IsArray(a)&&(l=a[0]),this.AddBlock=function(){if(1==this.Destroyed)return console.log("已经删除(刚进入AddBlock)"),!0;if(!this.IsAddingBlock){if(this.IsAddingBlock=!0,0!=this.CurrBlockNo&&0==this.CurrBlockNo%(e/f)&&0==this.IsNewPage)return this.IsAddingBlock=!1,void 0;if(this.CurrBlockNo>=parseInt((this.RecCount+f-1)/f))return this.IsAddingBlock=!1,void 0;var d=this.IsNewPage;CmnAjax.ShowAjaxHandleHint(i,l),c||(c={}),c["CurPage"]=this.CurrBlockNo+1,c["PageSize"]=f,CmnAjax.PostData(b,c,function(b){return CmnAjax.HideAjaxHandleHint(i),1==k.Destroyed?(console.log("已经删除"),!0):(j&&j(b.data),Cmn.FillData(a,b.data,d?!1:!0,!0),g&&g(b),k.CurrBlockNo++,k.IsNewPage=!1,k.IsAddingBlock=!1,k.RecCount=parseInt(b.RecCount),!0)},function(d){return CmnAjax.HideAjaxHandleHint(i),h&&h(d),Cmn.Log("PicStepLoad填充数据时Ajax报错！dataContainerSelector:"+a+" methodName:"+b+" param:"+c+" 错误详细信息："+d.responseText),!1})}},this.BindScrollLoadData=function(a,b){function f(){c=""!=k.ScrollContainerSelector?e[0].scrollHeight:document.body.scrollHeight||document.documentElement.scrollHeight;var a=e[0].clientHeight||e.height();e.scrollTop()+a+d>=c&&k.AddBlock()}var c,d,e;return a&&(this.ScrollContainerSelector=a),b&&(this.LoadingSensitivity=b),c=0,d=this.LoadingSensitivity,e=$("body"),""!=this.ScrollContainerSelector?(e=$(this.ScrollContainerSelector),c=e[0].scrollHeight):c=document.body.scrollHeight||document.documentElement.scrollHeight,Cmn.IsType(e[0],"htmlbodyelement")||Cmn.IsType(e[0],"htmldocument")?$(window).off("scroll").on("scroll",f):e.off("scroll").on("scroll",f),{Destroy:function(){e.off("scroll",f)}}},this.BindScrollLoadData(),this.Destroy=function(){if(Cmn.Func.IsArray(a))for(var b=0;b<a.length;b++)$(a[b]).siblings().html("");else $(a).siblings().html("");this.BindScrollLoadData().Destroy(),this.Destroyed=!0},null==d||"undefind"==typeof d||""==d?(this.AddBlock(),void 0):(m=function(a){k.CurrBlockNo=(a-1)*e/f,k.IsNewPage=!0,k.IsAddingBlock=!1,k.AddBlock()},this.Paging=new Cmn.Paging(d,0,e,m),this.Refresh=function(){k.AddBlock(),c||(c={}),c["CurPage"]=1,c["PageSize"]=e,CmnAjax.PostData(b,c,function(a){return k.Paging.RecCount=parseInt(a.RecCount),k.Paging.ToPage(1,!1),!0},function(d){return h&&h(d),Cmn.Log("picStepLoad填充数据时Ajax报错！dataContainerSelector:"+a+" methodName:"+b+" param:"+c+"  错误详细信息："+d.responseText),!1})},this.Refresh(),void 0)},SubmitData:function(containerSelector,methodName,param,checkRegular,errDispSelector,submitingHintSelector,successFunc,errorFunc){var _i,_tmpDom,_tmpValue,_retText,_isWebMethod,_execComplete,_tmpData,_data="",_errMsg="",_radioLst=new Array;if(methodName=CmnAjax.MethodNameToUrl(methodName),$(containerSelector).find("input[id][type!='button'][id!='__VIEWSTATE']").add(containerSelector+" textarea").add(containerSelector+" select").each(function(){var b,c,d,e,a=$(this).attr("id").toString();if(null!=a&&void 0!=a&&a.length>3){if(a=a.substring(3),"checkbox"==$(this).attr("type"))_value=$(this).attr("checked")?"1":"0";else{if("radio"==$(this).attr("type")){if(b=!1,c=$(this).attr("name"),c.length<=3)return;for(d=0;d<_radioLst.length;d++)if(_radioLst[d]==c){b=!0;break}return b||_radioLst.push(c),void 0}_value=$(this).val()}if(null!=checkRegular&&void 0!=checkRegular&&null!=checkRegular[a]&&void 0!=checkRegular[a]&&(e=Cmn.CheckValid(checkRegular[a],_value),1!=e))return _errMsg+=e,!1;_data.length>1&&(_data+=","),_data+="'"+a+"':'"+Cmn.Func.FormatJsonData(_value)+"'"}}),""!=_errMsg)return errDispSelector?$(errDispSelector).html(_errMsg):alert(_errMsg),!1;for(errDispSelector&&$(errDispSelector).html(""),_i=0;_i<_radioLst.length;_i++)_tmpDom=$("input[name='"+_radioLst[_i]+"']:checked"),_tmpValue="",_tmpDom.length>0&&(_tmpValue=_tmpDom.val()),_data.length>1&&(_data+=","),_data+="'"+_radioLst[_i].substring(3)+"':'"+_tmpValue+"'";if(""==_data)return!1;if(Cmn.Func.IsString(param)||(param=Cmn.Func.JsonToStr(param)),param&&""!=param&&(param=Cmn.Func.Trim(param),param=param.substring(1),param=param.substring(0,param.length-1),""!=param&&(_data=_data+","+param)),_retText="",methodName=CmnAjax.Func.GetProxyUrl(methodName),_isWebMethod=Cmn.Func.IsWebMethod(methodName),_execComplete=!1,_tmpData="{"+_data+"}",!_isWebMethod)try{_tmpData=eval("({"+_data+"})")}catch(err){Cmn.alert("输入的内容可能存在问题！错误信息："+err.message)}return CmnAjax.ShowAjaxHandleHint(submitingHintSelector),_retText=CmnAjax.GetData(methodName,_tmpData,submitingHintSelector,successFunc,errorFunc)},GetData:function(methodName,param,getingHintSelector,successFunc,errorFunc){var _methodName,_isWebMethod,_retText,_hasExecComplete,_dataType;if(void 0==param)param={};else if(Cmn.Func.IsString(param)){""==param&&(param="{}");try{param=eval("("+param+")")}catch(e){param={}}}return""!=Cmn.Func.Cookie.GetPrefix()&&(param[CmnAjax.Cfg.CookiePrefixParamName]=Cmn.Func.Cookie.GetPrefix()),CmnAjax.Cfg.ParamForAllRequest&&$.extend(param,CmnAjax.Cfg.ParamForAllRequest),param=CmnAjax.Func.AddSignature(methodName,param),_methodName=CmnAjax.MethodNameToUrl(methodName),_methodName=CmnAjax.Func.GetProxyUrl(_methodName),_isWebMethod=Cmn.Func.IsWebMethod(_methodName),_retText="",_hasExecComplete=!1,_isWebMethod&&(param=Cmn.Func.JsonToStr(param)),CmnAjax.ShowAjaxHandleHint(getingHintSelector),_dataType="text",$.ajax({type:"Post",url:_methodName,dataType:_dataType,jsonp:"callback",contentType:_isWebMethod?"application/json;charset=uft-8":"application/x-www-form-urlencoded",data:param,async:!1,success:function(retData){if(CmnAjax.HideAjaxHandleHint(getingHintSelector),_isWebMethod)if(_retText=eval("("+retData+")").d,null==_retText)_retText="";else try{_retText=eval("("+_retText+")")}catch(er){}else try{_retText=eval("("+retData+")")}catch(err){_retText=retData}CmnAjax.Func.IsNeedGetCgTk(methodName,_retText)?CmnAjax.GetData(Cmn.Func.AddParamToUrl(CmnAjax.Func.GetStdItfUrl(methodName),"method=GetCgTk"),{},"",function(a){"1"==a["IsSuccess"]&&a["CgTk"]&&""!=a["CgTk"]&&(CmnAjax.Func.SetItfToken(methodName,a["CgTk"],a["Time"],a["Milliseconds"]),_retText=CmnAjax.GetData(methodName,param,getingHintSelector,successFunc,errorFunc))},errorFunc):_retText&&_retText["ItfVerifyErrorNo"]&&"3"==_retText["ItfVerifyErrorNo"]&&(_retText=CmnAjax.GetData(methodName,param,getingHintSelector,successFunc,errorFunc)),successFunc&&successFunc(_retText),_hasExecComplete=!0},error:function(a){_hasExecComplete=!0,CmnAjax.HideAjaxHandleHint(getingHintSelector),Cmn.Log("GetData！ methodName:"+_methodName+" param:"+Cmn.Func.JsonToStr(param)+"  错误详细信息："+a.responseText),errorFunc&&errorFunc(a)}}),_retText},PostData:function(methodName,param,successFunc,errorFunc,loadingSelector){var _methodName,_isWebMethod,_dataType;if(void 0==param)param={};else if(Cmn.Func.IsString(param)){""==param&&(param="{}");try{param=eval("("+param+")")}catch(e){param={}}}""!=Cmn.Func.Cookie.GetPrefix()&&(param[CmnAjax.Cfg.CookiePrefixParamName]=Cmn.Func.Cookie.GetPrefix()),CmnAjax.Cfg.ParamForAllRequest&&$.extend(param,CmnAjax.Cfg.ParamForAllRequest),param=CmnAjax.Func.AddSignature(methodName,param),_methodName=CmnAjax.MethodNameToUrl(methodName),_methodName=CmnAjax.Func.GetProxyUrl(_methodName),_isWebMethod=Cmn.Func.IsWebMethod(_methodName),_isWebMethod&&(param=Cmn.Func.JsonToStr(param)),CmnAjax.ShowAjaxHandleHint(loadingSelector),_dataType="text",Cmn.Func.IsSameMainDomain(_methodName)===!1&&(_dataType="jsonp"),$.ajax({type:"Post",jsonp:"callback",url:_methodName,data:param,contentType:_isWebMethod?"application/json;charset=uft-8":"application/x-www-form-urlencoded",dataType:_dataType,success:function(retData){CmnAjax.HideAjaxHandleHint(loadingSelector);var _retVal="";if(_isWebMethod)if(_retVal=eval("("+retData+")").d,null==_retVal)_retVal="";else try{_retVal=eval("("+_retVal+")")}catch(er){}else try{_retVal=eval("("+retData+")")}catch(err){_retVal=retData}return CmnAjax.Func.IsNeedGetCgTk(methodName,_retVal)?CmnAjax.PostData(Cmn.Func.AddParamToUrl(CmnAjax.Func.GetStdItfUrl(methodName),"method=GetCgTk"),{},function(a){"1"==a["IsSuccess"]&&a["CgTk"]&&""!=a["CgTk"]?(CmnAjax.Func.SetItfToken(methodName,a["CgTk"],a["Time"],a["Milliseconds"]),CmnAjax.PostData(methodName,param,successFunc,errorFunc,loadingSelector)):successFunc&&successFunc(_retVal)},errorFunc):_retVal&&_retVal["ItfVerifyErrorNo"]&&"3"==_retVal["ItfVerifyErrorNo"]?CmnAjax.PostData(methodName,param,successFunc,errorFunc,loadingSelector):successFunc&&successFunc(_retVal),!0},error:function(a){return CmnAjax.HideAjaxHandleHint(loadingSelector),errorFunc&&errorFunc(a),Cmn.Log("PostData填充数据时Ajax报错！ methodName:"+_methodName+" param:"+Cmn.Func.JsonToStr(param)+"  错误详细信息："+a.responseText),!1}})},GetFile:function(a,b,c,d){var g,e="",f="text";return""==a?"":(g=!1,d===!1&&(g=!0),CmnAjax.ShowAjaxHandleHint(""),$.ajax({type:"GET",url:a,async:g,dataType:f,success:function(a){CmnAjax.HideAjaxHandleHint(""),e=a,b&&b(e)},error:function(b,d){CmnAjax.HideAjaxHandleHint(""),c&&c(),Cmn.Log("GetFile！ fileUrl:"+a+"； dataType:"+f+"；  错误详细信息："+d+"------"+b.responseText)}}),e)},GetField:function(fieldName,tableName,condition,orderBy){var _retText,_retVal;return condition=condition?condition.replace(new RegExp("'","g"),"\\'"):"",orderBy=orderBy?orderBy.replace(new RegExp("'","g"),"\\'"):"",_retText="",_retVal=$.ajax({type:"Post",url:"/CmnAjax/CmnAjax.aspx/GetField",dataType:"text",contentType:"application/json;charset=uft-8",async:!1,data:"{fieldName:'"+fieldName+"',tableName:'"+tableName+"',condition:'"+condition+"',orderBy:'"+orderBy+"'}",success:function(retData){try{_retText=eval("("+retData+")").d,_retText||(_retText=retData)}catch(err){_retText=retData}},error:function(a){Cmn.Log("GetField ajax调用错误！ fieldName:"+fieldName+"  tableName："+tableName+"  错误明细："+a.responseText)}}),_retText},ShowDefaultAjaxHintCount:0,ShowAjaxHandleHint:function(a,b){null!=a&&""!=a&&"undefind"!=typeof a?(null!=b&&""!=b&&"undefind"!=typeof b&&(Cmn.Func.IsArray(b)&&(b=b[0]),$(a).parent().children(b).length>0&&$(a).parent().each(function(){$(this).append($(this).children(a))})),$(a).show()):(0==CmnAjax.ShowDefaultAjaxHintCount&&1==CmnAjax.Cfg.ShowDefaultAjaxHint&&$("body").append("<div class='cmn_body_loading' style='position:fixed;right:4px;bottom:4px;font-size:12px;z-index:10001;color:#ffffff;padding:2px;padding-left:6px;padding-right:6px; background:rgba(33, 33, 33, 0.4) none repeat scroll 0 0 !important;filter:Alpha(opacity=40);background:#333333;'> <span style='position:relative;'> Loading... </span></div>"),CmnAjax.ShowDefaultAjaxHintCount++)},HideAjaxHandleHint:function(a){null!=a&&""!=a&&"undefind"!=typeof a?$(a).hide():(CmnAjax.ShowDefaultAjaxHintCount--,0==CmnAjax.ShowDefaultAjaxHintCount&&$("body .cmn_body_loading").remove())},Func:{GetProxyUrl:function(a){return""==CmnAjax.Cfg.ProxyUrl?a:a.indexOf("?TargetUrl=")>=0?a:CmnAjax.Cfg.ProxyUrl+"?TargetUrl="+encodeURIComponent(a)},HasLoadJsUrl:{},HasLoadCss:{},LoadJs:function(jsUrl,callback,isAllowRepeatLoad){var _jsUrl,_retVal="";return"undefined"==typeof isAllowRepeatLoad&&(isAllowRepeatLoad=!1),0==isAllowRepeatLoad?(_jsUrl=CmnAjax.Func.HasLoadJsUrl[jsUrl],(null==_jsUrl||void 0==_jsUrl)&&(CmnAjax.Func.HasLoadJsUrl[jsUrl]=jsUrl,_retVal=CmnAjax.GetFile(jsUrl,callback,callback))):_retVal=CmnAjax.GetFile(jsUrl,callback,callback),""!=_retVal&&eval(_retVal+" \r\n//# sourceURL="+jsUrl),_retVal},LoadCss:function(a){var b,c,d;if(!a||0===a.length)throw new Error('argument "path" is required !');b=CmnAjax.Func.HasLoadCss[a],b||(c=document.getElementsByTagName("head")[0],d=document.createElement("link"),d.href=a,d.rel="stylesheet",d.type="text/css",c.appendChild(d),CmnAjax.Func.HasLoadCss[a]=a)},SetItfToken:function(a,b,c,d){var e=CmnAjax.Func.GetVerifyCfg(a);e["CacheToken"]=b,e["CacheTokenLastGetTime"]=new Date,e["ServerTime"]=void 0!=c&&""!=c?new Date(c):new Date,e["Milliseconds"]=d?d:e["ServerTime"].getTime()},GetSignature:function(a,b){var c,d,e,f,g,h,i,j,k;a=Cmn.Func.Trim(a),c=CmnAjax.Func.GetVerifyCfg(a),(""==c["CacheToken"]||void 0==c["CacheToken"])&&(c["CacheToken"]="",Cmn.Log("在获取签名时，Tk为空。")),d=[],e="",f="",g=[],h=Cmn.Func.GetParamListFromurl(a),i={},$.extend(i,b,h);for(j in i)"Cg_sg"!=j&&(f=j.toLocaleLowerCase(),d.push(f),void 0==g[f]?g[f]=i[j]:Cmn.Log("接口验证时存在重复的键："+f+" 接口地址："+a));for(d.sort(),k=0;k<d.length;k++)e+="&"+d[k]+"="+g[d[k]];return e=e.substring(1,e.length)+CmnAjax.Cfg.ItfTokenKey+c["CacheToken"],e=$.md5(e)},AddSignature:function(url,param){var _verifyCfg=CmnAjax.Func.GetVerifyCfg(url);if(void 0==param)param={};else if(Cmn.IsType(param,"string"))try{param=eval("("+param+")")}catch(e){param={}}return Cmn.IsType(param,"object")&&void 0!=_verifyCfg["CacheToken"]&&""!=_verifyCfg["CacheToken"]&&(param["Cg_rm"]=Cmn.Math.Random(0,1),param["Cg_tt"]=parseInt(_verifyCfg["Milliseconds"])+(new Date-_verifyCfg["CacheTokenLastGetTime"]),param["Cg_sg"]=CmnAjax.Func.GetSignature(url,param)),param},IsNeedGetCgTk:function(a,b){var c,d;return b&&b["ItfVerifyErrorNo"]&&""!=b["ItfVerifyErrorNo"]&&(c=CmnAjax.Func.GetVerifyCfg(a),b["StdItfUrl"]&&""!=b["StdItfUrl"]&&(d=Cmn.Func.GetMainDomain(a),c["StdItfUrl"]="about:srcdoc"!=d&&d.toLowerCase()!=Cmn.Func.GetMainDomain(b["StdItfUrl"]).toLowerCase()?b["StdItfUrl"].replace(Cmn.Func.GetMainDomain(b["StdItfUrl"]),d):b["StdItfUrl"]),void 0==c["CacheToken"]||""==c["CacheToken"]||void 0==c["CacheTokenLastGetTime"]||(new Date-c["CacheTokenLastGetTime"])/1e3>5)?!0:!1},ClearCgTk:function(){CmnAjax.Cfg.ItfVerifyCfgList={}},GetVerifyCfg:function(a){var b=Cmn.Func.GetMainDomain(a).toLowerCase(),c=CmnAjax.Cfg.ItfVerifyCfgList[b];return c?c:(CmnAjax.Cfg.ItfVerifyCfgList[b]={},CmnAjax.Cfg.ItfVerifyCfgList[b])},GetStdItfUrl:function(a){var b=CmnAjax.Func.GetVerifyCfg(a);return b["StdItfUrl"]?b["StdItfUrl"]:InterfaceUrl},SetParamForAllRequest:function(a){CmnAjax.Cfg.ParamForAllRequest=a}}};Cmn.EasyItf=new function(){var a=this,b=function(a){var b="";return void 0==InterfaceUrl?(Cmn.Log("InterfaceUrl 未设置。需要引用前台网站的SiteConfig.js"),b=Cmn.Func.GetRoot()+"Cg/Itf/CSharp/EasyItf.aspx"):b=InterfaceUrl,Cmn.Func.AddParamToUrl(b,"method=EasyItf&ItfName="+a)};this.GetData=function(a,c,d,e,f){return a=b(a),d===!0?CmnAjax.GetData(a,c):(CmnAjax.PostData(a,c,e,f),void 0)},this.FillData=function(a,c,d,e,f,g){CmnAjax.FillData(a,b(c),d,e,f,g)},this.DataPaging=function(a,c,d,e,f,g,h,i,j){return new CmnAjax.DataPaging(a,b(c),d,e,f,g,h,i,j)},this.GetValue=function(a,c,d,e,f){var h,i,g=b(a);if(d===!0){if(h=CmnAjax.GetData(g,c),void 0!=h.data&&null!=h.data&&h.data.length>0)for(i in h.data[0])return h.data[0][i];return""}return void 0==e||null==e?(Cmn.alert("GetValue非阻塞方式必须提供successFunc回调函数！"),void 0):(CmnAjax.PostData(g,c,function(a){var c,b="";if(void 0!=a.data&&null!=a.data&&a.data.length>0)for(c in a.data[0]){b=a.data[0][c];break}e(b)},f),void 0)},this.Execute=function(b,c,d,e,f){if(d===!0){var g=a.GetData(b,c,!0);return g&&"1"==g["IsSuccess"]?!0:!1}a.GetData(b,c,!1,function(a){g&&"1"==g["IsSuccess"]?e(!0,a):e(!1,a)},f)}};
window.CmnAjax=CmnAjax;
